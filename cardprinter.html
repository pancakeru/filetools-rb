<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image Grid to PDF Exporter</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 0px;
    }
    #drop-area {
      border: 2px dashed #aaa;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      margin-bottom: 20px;
      transition: border-color 0.3s ease;
      cursor: pointer;
      color: #555;
    }
    #drop-area.hover {
      border-color: #666;
    }
    #container {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .page {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-evenly;
      page-break-after: always;
    }
    .image {
      width: 25%;
      margin: 1px 0;
      object-fit: contain;
      border: 1px solid #ccc;
      padding: 1px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    input[type="file"] {
      display: none;
    }

    #ui {
      text-align: center;
      align-items: center;
      align-content: center;
      align-self: center;
    }

    label {
      padding-right: 1%;
    }
  </style>
</head>
<body>

<div id="ui">
  <h1>ğŸ–¼ï¸ å›¾ç‰‡æ–‡ä»¶å¤¹ â†’ PDF</h1>
  <div id="drop-area">ğŸ“ å°†æ‚¨çš„ PNG æ–‡ä»¶å¤¹æ‹–æ”¾åˆ°æ­¤å¤„æˆ–å•å‡»â€œé€‰æ‹©â€</div>
  <input type="file" id="fileElem" webkitdirectory multiple accept="image/png">
  <br>
<label>
  <input type="checkbox" id="includeAlts" unchecked>
    åŒ…å«Alt
</label>

 <input type="checkbox" id="includeOnFiles" unchecked>
    åŒ…å«OVERNUMBER
</label>

  <p>PDF è®¾ç½®ï¼šæ¨ªå‘ï¼Œè¾¹è· 0</p>
  <button id="exportBtn">ğŸ“„ æŒ‰ä¸‹æ­¤ç„¶åæŒ‰ CMD+P</button>
</div>

<div id="container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
  const dropArea = document.getElementById('drop-area');
  const fileElem = document.getElementById('fileElem');
  const container = document.getElementById('container');
  const exportBtn = document.getElementById('exportBtn');

  let allImageFiles = [];

  dropArea.addEventListener('click', () => fileElem.click());
  fileElem.addEventListener('change', (e) => handleFiles(e.target.files));

  dropArea.addEventListener('dragover', e => {
    e.preventDefault();
    dropArea.classList.add('hover');
  });
  dropArea.addEventListener('dragleave', () => {
    dropArea.classList.remove('hover');
  });
  dropArea.addEventListener('drop', async e => {
    e.preventDefault();
    dropArea.classList.remove('hover');
    const items = [...e.dataTransfer.items];
    const files = [];

    for (let item of items) {
      const entry = item.webkitGetAsEntry();
      if (entry && entry.isDirectory) {
        await readFolder(entry, files);
      } else {
        const file = item.getAsFile();
        if (file && file.name.endsWith(".png")) {
          files.push(file);
        }
      }
    }

    handleFiles(files);
  });

  function handleFiles(fileList) {
   const includeAlts = document.getElementById("includeAlts").checked;

    allImageFiles = Array.from(fileList).filter(file => file.type === "image/png");
    renderImages();
  }

  function renderImages() {
  const includeAlts = document.getElementById("includeAlts").checked;
  const includeOn = document.getElementById("includeOnFiles").checked;

  const filteredFiles = allImageFiles
    .filter(file => {
      const name = file.name.toLowerCase().replace(".png", "");
      const fourthChar = name.charAt(3);

      if(!includeAlts && fourthChar !== "-") {
        return false;
      }

      if (!includeOn && name.includes("-on-")) {
        return false;
      }

      return true;
    })
    .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));

  const chunkSize = 8;
  container.innerHTML = "";

  for (let i = 0; i < filteredFiles.length; i += chunkSize) {
    const chunk = filteredFiles.slice(i, i + chunkSize);
    const page = document.createElement("div");
    page.className = "page";

    chunk.forEach(file => {
      const img = document.createElement("img");
      img.className = "image";
      img.src = URL.createObjectURL(file);
      page.appendChild(img);
    });

    container.appendChild(page);
  }
}

  async function readFolder(entry, fileArray) {
    const reader = entry.createReader();
    let entries = await new Promise(resolve => reader.readEntries(resolve));
    for (let ent of entries) {
      if (ent.isFile && ent.name.endsWith(".png")) {
        await new Promise(resolve => {
          ent.file(file => {
            fileArray.push(file);
            resolve();
          });
        });
      } else if (ent.isDirectory) {
        await readFolder(ent, fileArray);
      }
    }
  }

  exportBtn.addEventListener("click", () => {
    document.getElementById("ui").style.display = "none"; // hide UI before export
  });

  document.getElementById("includeAlts").addEventListener("change", renderImages);
  document.getElementById("includeOnFiles").addEventListener("change", renderImages);
  
</script>

</body>
</html>